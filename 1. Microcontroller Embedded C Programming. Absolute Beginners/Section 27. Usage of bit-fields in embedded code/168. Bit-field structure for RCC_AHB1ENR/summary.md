Це покращення коду для [цього прикладу](../../Section%2020.%20Looping/136.%20LED%20toggle%20using%20software%20delay/summary.md)

Ми робимо структури для всіх регістрів, які ми будемо використовувати.

```c


#ifndef MAIN_H_
#define MAIN_H_

#include<stdint.h>

typedef struct
{
	uint32_t gpioa_en		:1;
	uint32_t gpiob_en		:1;
	uint32_t gpioc_en		:1;
	uint32_t gpiod_en		:1;
	uint32_t gpioe_en		:1;
	uint32_t gpiof_en		:1;
	uint32_t gpiog_en		:1;
	uint32_t gpioh_en		:1;
	uint32_t gpioi_en		:1;
	uint32_t reserved1		:3;
	uint32_t crc_en			:1;
	uint32_t reserved2		:3;
	uint32_t reserved3		:2;
	uint32_t bkpsram_en		:1;
	uint32_t reserved4		:1;
	uint32_t ccmdat_en		:1;
	uint32_t dma1_en		:1;
	uint32_t dma2_en		:1;
	uint32_t reserved5		:2;
	uint32_t ethmac_en		:1;
	uint32_t ethmactx_en	:1;
	uint32_t ethmacrx_en	:1;
	uint32_t ethmacptp_en	:1;
	uint32_t otghs_en		:1;
	uint32_t otghsulpi_en	:1;
}RCC_AHB1ENR_t;

typedef struct
{
   uint32_t pin_0		:1;
   uint32_t pin_1		:1;
   uint32_t pin_2		:1;
   uint32_t pin_3		:1;
   uint32_t pin_4		:1;
   uint32_t pin_5		:1;
   uint32_t pin_6		:1;
   uint32_t pin_7		:1;
   uint32_t pin_8		:1;
   uint32_t pin_9		:1;
   uint32_t pin_10		:1;
   uint32_t pin_11		:1;
   uint32_t pin_12		:1;
   uint32_t pin_13		:1;
   uint32_t pin_14		:1;
   uint32_t pin_15		:1;
   uint32_t reserved	:16;
}GPIOx_ODR_t;


typedef struct
{
   uint32_t pin_0		:2;
   uint32_t pin_1		:2;
   uint32_t pin_2		:2;
   uint32_t pin_3		:2;
   uint32_t pin_4		:2;
   uint32_t pin_5		:2;
   uint32_t pin_6		:2;
   uint32_t pin_7		:2;
   uint32_t pin_8		:2;
   uint32_t pin_9		:2;
   uint32_t pin_10		:2;
   uint32_t pin_11		:2;
   uint32_t pin_12		:2;
   uint32_t pin_13		:2;
   uint32_t pin_14		:2;
   uint32_t pin_15		:2;
}GPIOx_MODE_t;

#endif /* MAIN_H_ */
```

## Приклад перемикання режиму піна
```c
GPIOx_MODE_t *pGpiodMode;
pGpiodMode = (GPIOx_MODE_t *)0x40020C00; // GPIOD mode register. consecutive 32 bits are mapped with members of the structure

pGpiodMode->pin_15 = 0x3; // set pin 15 to alternate function mode (11)
```

Compiler will generate the instructions to program the appropriate bit positions int the peripheral register address.
```c
*(0x40020C00) |= (3 << 30); // generated by compiler
```

## Повний покращений код
`main.c`
```c
#include "main.h"

int main(void)
{
    RCC_AHB1ENR_t volatile *const pClkCtrlReg = (RCC_AHB1ENR_t *)0x40023830; // RCC, clock control register
    GPIOx_MODE_t volatile *const pPortDModeReg = (GPIOx_MODE_t *)0x40020C00;
    GPIOx_ODR_t volatile *const pPortDOutReg = (GPIOx_ODR_t *)0x40020C14;

    // 1. Enable the clock for GPIOD peripheral, set 3rd bit to 1
    pClkCtrlReg->gpiod_en = 1; // GPIOD

    // 2. Configure the mode of the IO pin as output
    pPortDModeReg->pin_12 = 1; // set pin 12 to output mode

    // toggle LED using software delay
    while (1) {
        pPortDOutReg->pin_12 = 1; // set pin 12 to HIGH
        for (uint32_t i = 0; i < 500000; i++);
        pPortDOutReg->pin_12 = 0; // clear pin 12
        for (uint32_t i = 0; i < 500000; i++);
    }
}
```